{% extends "base.html" %}

{% block title %}Trade {{ ticker }}{% endblock %}

{% block content %}
<div class="content-container" style="max-width: 600px;">
    <h1>
        Trade {{ stock.get('shortName', ticker) }}
        <span style="font-size:0.7em; color:#777;">({{ ticker }})</span>
    </h1>
    <div style="text-align:center; font-size:1.5em; margin-bottom:25px;">
        Aktueller Kurs: €{{ stock.get('regularMarketPrice', 'N/A') | round(2) if stock.get('regularMarketPrice') is not none else 'N/A' }}
    </div>

    <div style="display: flex; justify-content: space-around; background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <span style="display:block; font-size:0.9em; color:#6c757d;">Verfügbares Kapital</span>
            <strong style="font-size:1.2em;">€{{ "{:,.2f}".format(available_cash) if available_cash is not none else 'N/A' }}</strong>
        </div>

        {% if position %}
        <div>
            <span style="display:block; font-size:0.9em; color:#6c757d;">Im Depot</span>
            <strong style="font-size:1.2em;">{{ position.quantity }} Stk.</strong>
        </div>
        <div id="avg-purchase-price-info" style="display: none;">
            <span style="display:block; font-size:0.9em; color:#6c757d;">Dein Ø Kaufpreis</span>
            <strong style="font-size:1.2em;">€{{ "{:,.2f}".format(position.average_purchase_price) if position.average_purchase_price is not none else 'N/A' }}</strong>
        </div>

        {% if absolute_profit_loss is not none %}
        <div id="profit-loss-info" style="display: none;"
             data-total-quantity="{{ position.quantity }}"
             data-avg-price="{{ position.average_purchase_price }}"
             data-market-price="{{ stock.get('regularMarketPrice', 0) }}">
            <span style="display:block; font-size:0.9em; color:#6c757d;">Potenzieller G/V</span>
            <strong id="profit-loss-value" style="font-size:1.2em;">
            </strong>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('trade_page', ticker_symbol=ticker) }}" id="trade-form">
        <div class="form-group">
            <label for="order_type">Order-Typ</label>
            <select class="form-control" id="order_type" name="order_type" required>
                <option value="MARKET_BUY">Market Buy</option>
                <option value="MARKET_SELL">Market Sell</option>
                <option value="LIMIT_BUY">Limit Buy</option>
                <option value="LIMIT_SELL">Limit Sell</option>
                <option value="STOP_LOSS_SELL">Stop Loss (Sell)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="quantity">Menge</label>
            <input type="number" min="1" class="form-control" id="quantity" name="quantity" placeholder="z.B. 10" required>
        </div>

        <div class="form-group" id="limit-price-group" style="display: none;">
            <label for="limit_price">Limit-Preis</label>
            <input type="number" step="any" min="0.01" class="form-control" id="limit_price" name="limit_price" placeholder="Preis pro Aktie">
        </div>

        <div class="form-group" id="stop-price-group" style="display: none;">
            <label for="stop_price">Stop-Preis</label>
            <input type="number" step="any" min="0.01" class="form-control" id="stop_price" name="stop_price" placeholder="Preis, bei dem verkauft wird">
        </div>

        <button type="submit" class="form-button full-width" style="margin-top:10px;">Order platzieren</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element-Referenzen ---
    const orderTypeSelect = document.getElementById('order_type');
    const quantityInput = document.getElementById('quantity');
    const limitPriceInput = document.getElementById('limit_price');
    const stopPriceInput = document.getElementById('stop_price');

    const limitPriceGroup = document.getElementById('limit-price-group');
    const stopPriceGroup = document.getElementById('stop-price-group');

    const profitLossInfo = document.getElementById('profit-loss-info');
    const profitLossValue = document.getElementById('profit-loss-value');
    const avgPurchasePriceInfo = document.getElementById('avg-purchase-price-info');

    // --- Hilfsfunktionen ---
    function formatCurrency(value) {
        return `€${value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatPercentage(value) {
        const sign = value >= 0 ? '+' : '';
        return `(${sign}${value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%)`;
    }

    function updatePLDisplay(absPL, relPL) {
        if (!profitLossValue) return;
        profitLossValue.style.color = absPL >= 0 ? '#198754' : '#dc3545';
        profitLossValue.innerHTML = `${formatCurrency(absPL)} <span style="font-size:0.8em; display:block;">${formatPercentage(relPL)}</span>`;
    }

    // --- Hauptlogik ---
    function calculateAndUpdatePL() {
        if (!profitLossInfo) return;

        const sellQuantity = parseFloat(quantityInput.value);
        const avgPrice = parseFloat(profitLossInfo.dataset.avgPrice);
        const selectedType = orderTypeSelect.value;

        let sellPrice = 0;
        if (selectedType === 'LIMIT_SELL') {
            sellPrice = parseFloat(limitPriceInput.value);
        } else if (selectedType === 'STOP_LOSS_SELL') {
            sellPrice = parseFloat(stopPriceInput.value);
        } else { // MARKET_SELL
            sellPrice = parseFloat(profitLossInfo.dataset.marketPrice);
        }

        if (isNaN(sellQuantity) || isNaN(avgPrice) || isNaN(sellPrice) || sellQuantity <= 0 || sellPrice <= 0) {
            profitLossValue.innerHTML = ''; // Feld leeren bei ungültiger Eingabe
            return;
        }

        const purchaseValuePerShare = avgPrice;
        const sellValuePerShare = sellPrice;

        // Relativer G/V ist unabhängig von der Menge
        const relPL = (purchaseValuePerShare !== 0) ? ((sellValuePerShare - purchaseValuePerShare) / purchaseValuePerShare) * 100 : 0;

        // Absoluter G/V hängt von der Menge ab
        const absPL = (sellValuePerShare - purchaseValuePerShare) * sellQuantity;

        updatePLDisplay(absPL, relPL);
    }

    function toggleDynamicElements() {
        const selectedType = orderTypeSelect.value;

        // Standardmäßig alles ausblenden
        limitPriceGroup.style.display = 'none';
        limitPriceInput.required = false;
        stopPriceGroup.style.display = 'none';
        stopPriceInput.required = false;

        if (profitLossInfo) profitLossInfo.style.display = 'none';
        if (avgPurchasePriceInfo) avgPurchasePriceInfo.style.display = 'none';

        // Gezielt einblenden
        if (selectedType === 'LIMIT_BUY' || selectedType === 'LIMIT_SELL') {
            limitPriceGroup.style.display = 'block';
            limitPriceInput.required = true;
        }

        if (selectedType === 'STOP_LOSS_SELL') {
            stopPriceGroup.style.display = 'block';
            stopPriceInput.required = true;
        }

        const sellTypes = ['MARKET_SELL', 'LIMIT_SELL', 'STOP_LOSS_SELL'];
        if (profitLossInfo && sellTypes.includes(selectedType)) {
            profitLossInfo.style.display = 'initial';
            if (avgPurchasePriceInfo && (selectedType === 'LIMIT_SELL' || selectedType === 'STOP_LOSS_SELL')) {
                avgPurchasePriceInfo.style.display = 'initial';
            }
            calculateAndUpdatePL();
        } else {
            if(profitLossValue) profitLossValue.innerHTML = '';
        }
    }

    // --- Event-Listener ---
    orderTypeSelect.addEventListener('change', toggleDynamicElements);
    quantityInput.addEventListener('input', calculateAndUpdatePL);
    limitPriceInput.addEventListener('input', calculateAndUpdatePL);
    stopPriceInput.addEventListener('input', calculateAndUpdatePL);

    // Initialer Aufruf, um den korrekten Zustand beim Laden der Seite herzustellen
    toggleDynamicElements();
});
</script>
{% endblock %}