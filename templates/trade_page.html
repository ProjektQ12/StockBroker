{% extends "base.html" %}

{% block title %}Trade {{ ticker }}{% endblock %}

{% block content %}
<div class="content-container" style="max-width: 600px;">
    <h1>
        Trade {{ stock.get('shortName', ticker) }}
        <span style="font-size:0.7em; color:#777;">({{ ticker }})</span>
    </h1>
    <div style="text-align:center; font-size:1.5em; margin-bottom:25px;">
        Aktueller Kurs: €{{ stock.get('regularMarketPrice', 'N/A') | round(2) if stock.get('regularMarketPrice') is not none else 'N/A' }}
    </div>

    <div style="display: flex; justify-content: space-around; background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <span style="display:block; font-size:0.9em; color:#6c757d;">Verfügbares Kapital</span>
            <strong style="font-size:1.2em;">€{{ "{:,.2f}".format(available_cash) if available_cash is not none else 'N/A' }}</strong>
        </div>

        {% if position %}
        <div>
            <span style="display:block; font-size:0.9em; color:#6c757d;">Im Depot</span>
            <strong style="font-size:1.2em;">{{ position.quantity }} Stk.</strong>
        </div>

        {% if absolute_profit_loss is not none %}
        <div id="profit-loss-info" style="display: none;">
            <span style="display:block; font-size:0.9em; color:#6c757d;">Potenzieller G/V</span>
            <strong style="font-size:1.2em; color: {{ '#198754' if absolute_profit_loss >= 0 else '#dc3545' }};">
                €{{ "{:,.2f}".format(absolute_profit_loss) }}
                {% if relative_profit_loss is not none %}
                    <span style="font-size:0.8em; display:block;">({{ "{:+.2f}".format(relative_profit_loss) }}%)</span>
                {% endif %}
            </strong>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('trade_page', ticker_symbol=ticker) }}" id="trade-form">
        <div class="form-group">
            <label for="order_type">Order-Typ</label>
            <select class="form-control" id="order_type" name="order_type" required>
                <option value="MARKET_BUY">Market Buy</option>
                <option value="MARKET_SELL">Market Sell</option>
                <option value="LIMIT_BUY">Limit Buy</option>
                <option value="LIMIT_SELL">Limit Sell</option>
                <option value="STOP_LOSS_SELL">Stop Loss (Sell)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="quantity">Menge</label>
            <input type="number" min="1" class="form-control" id="quantity" name="quantity" placeholder="z.B. 10" required>
        </div>

        <div class="form-group" id="limit-price-group" style="display: none;">
            <label for="limit_price">Limit-Preis</label>
            <input type="number" step="any" min="0.01" class="form-control" id="limit_price" name="limit_price" placeholder="Preis pro Aktie">
        </div>

        <div class="form-group" id="stop-price-group" style="display: none;">
            <label for="stop_price">Stop-Preis</label>
            <input type="number" step="any" min="0.01" class="form-control" id="stop_price" name="stop_price" placeholder="Preis, bei dem verkauft wird">
        </div>

        <button type="submit" class="form-button full-width" style="margin-top:10px;">Order platzieren</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Alle relevanten HTML-Elemente einmalig holen
    const orderTypeSelect = document.getElementById('order_type');
    const limitPriceGroup = document.getElementById('limit-price-group');
    const stopPriceGroup = document.getElementById('stop-price-group');
    const limitPriceInput = document.getElementById('limit_price');
    const stopPriceInput = document.getElementById('stop_price');
    const profitLossInfo = document.getElementById('profit-loss-info');

    // 2. Funktion zum Anzeigen/Verstecken der Felder definieren
    function toggleDynamicElements() {
        const selectedType = orderTypeSelect.value;
        console.log("Neuer Order-Typ ausgewählt:", selectedType); // Zum Debuggen in der Browser-Konsole

        // --- Standardzustand: Alle optionalen Elemente sind versteckt ---
        limitPriceGroup.style.display = 'none';
        limitPriceInput.required = false;

        stopPriceGroup.style.display = 'none';
        stopPriceInput.required = false;

        if (profitLossInfo) {
            profitLossInfo.style.display = 'none';
        }

        // --- Logik zum gezielten Einblenden ---

        // Zeige Limit-Feld für Limit-Orders
        if (selectedType === 'LIMIT_BUY' || selectedType === 'LIMIT_SELL') {
            limitPriceGroup.style.display = 'block';
            limitPriceInput.required = true;
        }

        // Zeige Stop-Feld für Stop-Loss-Orders
        if (selectedType === 'STOP_LOSS_SELL') {
            stopPriceGroup.style.display = 'block';
            stopPriceInput.required = true;
        }

        // Zeige G/V-Info für alle Verkaufs-Typen, falls die Box existiert
        const sellTypes = ['MARKET_SELL', 'LIMIT_SELL', 'STOP_LOSS_SELL'];
        if (profitLossInfo && sellTypes.includes(selectedType)) {
            // 'block' ist hier nicht ideal, da es ein Flex-Item ist.
            // Wir setzen es auf 'initial', damit es seinen ursprünglichen display-Wert wieder annimmt.
            profitLossInfo.style.display = 'initial';
        }
    }

    // 3. Event-Listener an das Dropdown-Menü binden
    orderTypeSelect.addEventListener('change', toggleDynamicElements);

    // 4. Funktion einmal beim Laden der Seite ausführen, um den korrekten Anfangszustand herzustellen
    toggleDynamicElements();
});
</script>
{% endblock %}