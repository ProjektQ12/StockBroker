{# ... (extends base.html, content block, Quote-Anzeige, Chart-Fehleranzeige) ... #}

    {# --- Chart-Bereich --- #}
    <h3>Kursverlauf</h3>
    {% if chart_error %}
        {# Fehleranzeige wie zuvor #}
        <p class="error">Fehler beim Laden der Chart-Daten: {{ chart_error }}</p>
        <script>console.error("Chart Error from backend:", {{ chart_error|tojson }});</script>
    {% elif chart_dates_json != 'null' and chart_prices_json != 'null' %} {# Prüfung im Template bleibt sinnvoll #}
        {# Buttons für Zeitrahmen (unverändert) #}
        <div class="timeframe-buttons" style="margin-bottom: 15px;">
            <button onclick="updateChartRange('1M')">1 Monat</button>
            <button onclick="updateChartRange('6M')">6 Monate</button>
            <button onclick="updateChartRange('1Y')">1 Jahr</button>
            <button onclick="updateChartRange('5Y')">5 Jahre</button>
            <button onclick="updateChartRange('Max')">Max</button>
        </div>

        {# Canvas für den Chart (unverändert) #}
        <div style="max-width: 760px; margin: auto;">
             <canvas id="stockChartCanvas"></canvas>
        </div>

        {# Chart.js einbinden (CDN) (unverändert) #}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            console.log("--- Chart Script Start ---");

            // 1. Daten vom backend übernehmen (KEIN JSON.parse mehr nötig!)
            // Jinja2 mit |safe fügt die Daten direkt als JS-Literal ein.
            // Wenn das backend 'null' (als String) sendet, wird hier das JS-null eingefügt.
            const allDates = {{ chart_dates_json|safe }};
            const allPrices = {{ chart_prices_json|safe }};
            const stockSymbol = {{ symbol|tojson }}; // tojson ist hier gut für Strings
            const currencySymbol = {{ currency|tojson }};

            // 2. Loggen und Prüfen der übernommenen Daten
            console.log("Daten direkt übernommen (sollten Arrays oder null sein):");
            console.log(`allDates (Typ: ${typeof allDates}, Länge: ${Array.isArray(allDates) ? allDates.length : 'N/A'}):`, Array.isArray(allDates) ? allDates.slice(0, 5) : allDates);
            console.log(`allPrices (Typ: ${typeof allPrices}, Länge: ${Array.isArray(allPrices) ? allPrices.length : 'N/A'}):`, Array.isArray(allPrices) ? allPrices.slice(0, 5) : allPrices);

            let dataValid = Array.isArray(allDates) && Array.isArray(allPrices) && allDates.length > 0 && allPrices.length === allDates.length;
            if (!dataValid) {
                 console.warn("Chartdaten sind ungültig oder leer nach Übernahme aus Template.");
                 // Optional: Fehlermeldung im HTML anzeigen
                 const errorContainer = document.createElement('p');
                 errorContainer.textContent = 'Fehler: Chartdaten konnten nicht korrekt geladen werden.';
                 errorContainer.className = 'error';
                 // Füge es nach den Buttons ein, wenn das Element existiert
                 const buttonContainer = document.querySelector('.timeframe-buttons');
                 if (buttonContainer) {
                    buttonContainer.insertAdjacentElement('afterend', errorContainer);
                 }
            }


            let stockChart = null; // Globale Variable für das Chart-Objekt

            // Funktion renderChart (unverändert lassen, sie erwartet bereits Arrays)
            function renderChart(displayDates, displayPrices) {
                console.log(`renderChart called with ${displayDates ? displayDates.length : 0} dates.`);
                // Prüfen ob displayDates/displayPrices valide Arrays sind
                 if (!Array.isArray(displayDates) || !Array.isArray(displayPrices) || displayDates.length === 0 || displayDates.length !== displayPrices.length) {
                    console.warn("renderChart: Keine gültigen Daten zum Anzeigen.");
                    if (stockChart) {
                       stockChart.destroy();
                       stockChart = null;
                    }
                    const ctx = document.getElementById('stockChartCanvas');
                    if (ctx) {
                       const context = ctx.getContext('2d');
                       context.clearRect(0, 0, ctx.width, ctx.height);
                       context.textAlign = "center";
                       context.fillText("Keine Chartdaten für diesen Zeitraum.", ctx.width / 2, ctx.height / 2);
                    }
                    return;
                }

                const ctx = document.getElementById('stockChartCanvas');
                if (!ctx) {
                    console.error("Canvas context 'stockChartCanvas' konnte nicht gefunden werden!");
                    return;
                }
                console.log("Canvas context gefunden.");

                const chartData = { /* ... wie zuvor ... */
                    labels: displayDates,
                    datasets: [{
                        label: `Schlusskurs (${stockSymbol}) ${currencySymbol}`,
                        data: displayPrices,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        borderWidth: 1.5,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                    }]
                };
                const chartConfig = { /* ... wie zuvor ... */
                     type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                             x: {
                                type: 'time',
                                time: {
                                    tooltipFormat: 'll',
                                     parser: 'yyyy-MM-dd',
                                     unit: 'month',
                                     displayFormats: {
                                        'day': 'DD MMM',
                                        'week': 'll',
                                        'month': 'MMM YY',
                                        'year': 'YYYY'
                                    }
                                },
                                title: { display: true, text: 'Datum' }
                            },
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: `Preis (${currencySymbol})` }
                            }
                        },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false },
                            title: { display: false }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false }
                    }
                 };

                if (stockChart) {
                    console.log("Chart existiert, wird aktualisiert.");
                    stockChart.data.labels = displayDates;
                    stockChart.data.datasets[0].data = displayPrices;
                    stockChart.update();
                    console.log("Chart aktualisiert.");
                } else {
                    console.log("Erstelle neuen Chart.");
                    try {
                         stockChart = new Chart(ctx, chartConfig);
                         console.log("Neuer Chart erstellt:", stockChart);
                    } catch(chartError) {
                         console.error("Fehler beim Erstellen des Charts mit new Chart():", chartError);
                         const errorContainer = document.createElement('p');
                         errorContainer.textContent = 'Fehler: Chart konnte nicht initialisiert werden (siehe Konsole).';
                         errorContainer.className = 'error';
                          const buttonContainer = document.querySelector('.timeframe-buttons');
                          if (buttonContainer) { buttonContainer.insertAdjacentElement('afterend', errorContainer); }
                    }
                }
            }

            // Funktion updateChartRange (unverändert lassen, greift jetzt auf korrekt initialisiertes allDates zu)
             function updateChartRange(range) {
                console.log(`updateChartRange called with: ${range}`);
                // Prüfen ob die globalen Daten valide sind
                if (!dataValid) { // Benutze die globale Variable dataValid
                     console.warn("updateChartRange: Keine gültigen globalen Daten vorhanden zum Filtern.");
                     renderChart(null, null); // Chart leeren
                     return;
                }

                const endDate = new Date(allDates[allDates.length - 1]);
                let startDate;
                switch(range) {
                    // ... Cases ...
                    case '1M': startDate = new Date(endDate); startDate.setMonth(endDate.getMonth() - 1); break;
                    case '6M': startDate = new Date(endDate); startDate.setMonth(endDate.getMonth() - 6); break;
                    case '1Y': startDate = new Date(endDate); startDate.setFullYear(endDate.getFullYear() - 1); break;
                    case '5Y': startDate = new Date(endDate); startDate.setFullYear(endDate.getFullYear() - 5); break;
                    case 'Max': default: startDate = new Date(allDates[0]); break;
                }
                const startDateString = startDate.toISOString().split('T')[0];
                console.log(`Filtering dates from ${startDateString} to ${allDates[allDates.length - 1]}`);

                const filteredDates = [];
                const filteredPrices = [];
                for (let i = 0; i < allDates.length; i++) {
                    if (allDates[i] >= startDateString) {
                        filteredDates.push(allDates[i]);
                        filteredPrices.push(allPrices[i]);
                    }
                }
                console.log(`Filtering done. Result length: ${filteredDates.length}`);
                renderChart(filteredDates, filteredPrices);
            }


            // Initialen Chart rendern
            document.addEventListener('DOMContentLoaded', (event) => {
                console.log("DOMContentLoaded event fired.");
                 // Prüfen ob Daten valide sind *bevor* der erste Render versucht wird
                if (dataValid) {
                     console.log("Attempting initial chart render.");
                     updateChartRange('1Y'); // Starte mit 1 Jahr Ansicht
                } else {
                    console.warn("Keine validen Chartdaten zum Initialisieren vorhanden.");
                     // Optional: Platzhalter im Canvas, falls renderChart nicht aufgerufen wird
                     const ctx = document.getElementById('stockChartCanvas');
                     if (ctx && !stockChart) {
                       const context = ctx.getContext('2d');
                       context.clearRect(0, 0, ctx.width, ctx.height);
                       context.textAlign = "center";
                       context.fillText("Chartdaten konnten nicht geladen werden.", ctx.width / 2, ctx.height / 2);
                     }
                }
            });

            console.log("--- Chart Script End ---");
        </script>

    {% else %}
        {# Fallback, wenn backend 'null' gemeldet hat #}
        <p>Keine Chart-Daten verfügbar für {{ symbol }}.</p>
        <script>console.warn("backend reported no chart data available (chart_dates_json or chart_prices_json was null).");</script>
    {% endif %}

    <p style="margin-top: 20px;"><a href="/">Zurück zur Suche</a></p>
{% endblock %}